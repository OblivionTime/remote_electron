"use strict";const{app:r,BrowserWindow:u,Tray:g,Menu:f,nativeImage:E,globalShortcut:v,screen:C,ipcMain:s,dialog:R}=require("electron"),{startWatchClipboard:M,stopWatchClipboard:b}=require("./clipboard.js"),{join:h,dirname:I}=require("path"),{spawn:x}=require("child_process");let w;require("url");process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true";let e,n;const d=E.createFromPath(h(__dirname,"logo.png"));s.on("showFloating",()=>{t||S()});s.on("closeFloating",()=>{t&&(t.close(),t=null,e.show(),n.destroy(),n=null,p())});s.on("startWatchClipboard",(o,i)=>{b(),M(e,i)});s.on("stopWatchClipboard",()=>{b()});s.on("createSuspensionMenu",o=>{f.buildFromTemplate([{label:"隐藏",click:()=>{t.hide()}},{label:"退出远控",click:()=>{const a={type:"question",buttons:["取消","确定"],defaultId:1,title:"警告",message:"点击退出后,目标将无法在远控当前设备",detail:""};R.showMessageBox(null,a).then(c=>{c.response===1&&(t.close(),t=null,e.show(),n.destroy(),n=null,p(),e.webContents.send("video_disconnect","发送成功"))})}}]).popup({})});const m=()=>{if(e=new u({frame:!1,width:750,useContentSize:!0,icon:d,height:510,minWidth:750,minHeight:510,center:!0,useContenRtSize:!0,autoHideMenuBar:!0,webPreferences:{nodeIntegration:!0,enableRemoteModule:!0,contextIsolation:!1}}),p(),e.webContents.on("did-finish-load",()=>{e.webContents.send("connect","发送成功")}),process.env.VITE_DEV_SERVER_URL)e.loadURL(process.env.VITE_DEV_SERVER_URL+"#/index");else{e.setMenu(null);const o=r.getAppPath();process.chdir(o+"/../../"),w=x("remote.exe"),e.loadFile(h(__dirname,"../dist/index.html")),e.webContents.executeJavaScript("window.location.hash = '#/index';")}},p=()=>{n=new g(d);const o=f.buildFromTemplate([{label:"主界面",click:()=>e.show()},{label:"退出",click:()=>r.exit()}]);n.on("double-click",()=>{e.show()}),n.setToolTip("山与路远程控制"),n.setContextMenu(o),e.on("close",i=>{e.hide(),e.setSkipTaskbar(!0),i.preventDefault()})};let t=null;const S=()=>{e.hide(),n&&(n.destroy(),n=null),t=new u({frame:!1,width:80,alwaysOnTop:!0,useContentSize:!0,icon:d,height:300,maxWidth:80,maxHeight:300,resizable:!1,useContenRtSize:!0,autoHideMenuBar:!0,transparent:!0,type:"toolbar",webPreferences:{nodeIntegration:!0,enableRemoteModule:!0,contextIsolation:!1}});const{left:o,top:i}={left:C.getPrimaryDisplay().workAreaSize.width-160,top:80};t.setPosition(o,i),t.setMaximizable(!1),n=new g(d);const a=f.buildFromTemplate([{label:"显示",click:()=>t.show()},{label:"退出",click:()=>{const c={type:"question",buttons:["取消","确定"],defaultId:1,title:"警告",message:"点击退出后,目标将无法在远控当前设备",detail:""};R.showMessageBox(null,c).then(_=>{_.response===1&&(t.close(),t=null,e.show(),n.destroy(),n=null,p(),e.webContents.send("video_disconnect","发送成功"))})}}]);n.on("double-click",()=>{t.show()}),n.setToolTip("你当前正在被控制中..."),n.setContextMenu(a),process.env.VITE_DEV_SERVER_URL?t.loadURL(process.env.VITE_DEV_SERVER_URL+"#/controlledEnd"):(t.loadFile(h(__dirname,"../dist/index.html")),t.webContents.executeJavaScript("window.location.hash = '#/controlledEnd';"))};let l;s.on("closeFileDialog",()=>{l&&(l.close(),l=null)});s.on("createFileWindow",(o,i)=>{const{identificationCode:a,verificationCode:c}=i;T(a,c)});const T=(o,i)=>{if(l){e.webContents.send("errmsg","目前只支持远程一个目标进行传输文件");return}l=new u({width:850,useContentSize:!0,icon:d,height:610,minWidth:850,minHeight:610,center:!0,title:"文件传输",useContenRtSize:!0,autoHideMenuBar:!0,webPreferences:{nodeIntegration:!0,enableRemoteModule:!0,contextIsolation:!1}}),l.on("close",a=>{l&&(l=null)}),process.env.VITE_DEV_SERVER_URL?l.loadURL(process.env.VITE_DEV_SERVER_URL+`#/fileManage?device=${o}&code=${i}`):(l.loadFile(h(__dirname,"../dist/index.html")),l.webContents.executeJavaScript(`window.location.hash = '#/fileManage?device=${o}&code=${i}';`))};r.whenReady().then(()=>{m(),r.on("activate",()=>{u.getAllWindows().length===0&&m()})});r.on("window-all-closed",()=>{try{b(),w&&process.kill(w.pid)}catch{}process.platform!=="darwin"&&r.quit()});
